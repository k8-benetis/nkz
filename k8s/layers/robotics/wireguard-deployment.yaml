# =============================================================================
# WireGuard VPN - Deployment para Kubernetes
# =============================================================================
# VPN para conexión segura de robots ROS2 remotos
# Permite que robots se conecten de forma segura a la plataforma
# =============================================================================

---
# =============================================================================
# Namespace para VPN (aislado)
# =============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: nekazari-vpn
  labels:
    name: nekazari-vpn
    app: nekazari
    component: vpn

---
# =============================================================================
# ConfigMap con configuración de WireGuard
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: wireguard-config
  namespace: nekazari-vpn
  labels:
    app: wireguard
    component: vpn
data:
  wg0.conf: |
    [Interface]
    Address = 10.8.0.1/24
    ListenPort = 51820
    PrivateKey = ${WIREGUARD_PRIVATE_KEY}
    PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
    
    # Peers se añaden dinámicamente o via ConfigMap separado

  # Script para generar configuraciones de clientes
  generate-client.sh: |
    #!/bin/bash
    # Script para generar configuración de cliente WireGuard
    
    set -e
    
    CLIENT_NAME="${1:-robot_001}"
    SERVER_PUBLIC_KEY="${WIREGUARD_PUBLIC_KEY}"
    SERVER_ENDPOINT="${WIREGUARD_SERVER_ENDPOINT:-your-server-ip:51820}"
    CLIENT_NUMBER="${2:-2}"
    
    # Generar claves del cliente
    CLIENT_PRIVATE_KEY=$(wg genkey)
    CLIENT_PUBLIC_KEY=$(echo "$CLIENT_PRIVATE_KEY" | wg pubkey)
    CLIENT_IP="10.8.0.${CLIENT_NUMBER}"
    
    echo "================================================"
    echo "WireGuard Client Configuration: ${CLIENT_NAME}"
    echo "================================================"
    echo ""
    echo "Client IP: ${CLIENT_IP}"
    echo "Client Public Key: ${CLIENT_PUBLIC_KEY}"
    echo ""
    echo "================================================"
    echo "Configuration file (save as ${CLIENT_NAME}.conf):"
    echo "================================================"
    echo ""
    
    cat <<EOF
    [Interface]
    PrivateKey = ${CLIENT_PRIVATE_KEY}
    Address = ${CLIENT_IP}/24
    DNS = 10.8.0.1
    
    [Peer]
    PublicKey = ${SERVER_PUBLIC_KEY}
    Endpoint = ${SERVER_ENDPOINT}
    AllowedIPs = 10.8.0.0/24, 10.43.0.0/16
    PersistentKeepalive = 25
    EOF
    
    echo ""
    echo "================================================"
    echo "Add this peer to server (wg0.conf):"
    echo "================================================"
    echo ""
    
    cat <<EOF
    [Peer]
    # ${CLIENT_NAME}
    PublicKey = ${CLIENT_PUBLIC_KEY}
    AllowedIPs = ${CLIENT_IP}/32
    EOF
    
    echo ""
    echo "================================================"
    echo "IMPORTANT: Add the peer configuration above to"
    echo "the WireGuard server and reload the service"
    echo "================================================"

  # Script para listar clientes conectados
  list-peers.sh: |
    #!/bin/bash
    # Script para listar peers conectados
    
    echo "================================================"
    echo "WireGuard Connected Peers"
    echo "================================================"
    echo ""
    
    wg show wg0
    
    echo ""
    echo "================================================"
    echo "Active connections:"
    echo "================================================"
    wg show wg0 | grep -E "peer:|allowed ips:|latest handshake:" | sed 's/^/  /'

---
# =============================================================================
# Secret para claves de WireGuard
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: wireguard-keys
  namespace: nekazari-vpn
  labels:
    app: wireguard
    component: vpn
type: Opaque
stringData:
  # IMPORTANTE: Generar estas claves antes de desplegar
  # wg genkey | tee privatekey | wg pubkey > publickey
  private-key: "CHANGE_ME_GENERATE_WITH_wg_genkey"
  public-key: "CHANGE_ME_GENERATE_WITH_wg_pubkey"

---
# =============================================================================
# Deployment de WireGuard
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wireguard
  namespace: nekazari-vpn
  labels:
    app: wireguard
    component: vpn
spec:
  replicas: 1  # Solo 1 replica para VPN
  selector:
    matchLabels:
      app: wireguard
  
  template:
    metadata:
      labels:
        app: wireguard
        component: vpn
      annotations:
        description: "WireGuard VPN server for ROS2 robots"
    
    spec:
      # ServiceAccount con permisos mínimos
      serviceAccountName: wireguard-sa
      
      # WireGuard requiere hostNetwork para funcionar correctamente
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      
      # Security Context (WireGuard necesita privilegios de red)
      # Nota: sysctls no se pueden usar con hostNetwork=true
      # Los sysctls se configuran a nivel del nodo
      
      containers:
      - name: wireguard
        image: linuxserver/wireguard:latest
        imagePullPolicy: IfNotPresent
        
        # Security Context a nivel de contenedor
        securityContext:
          privileged: false  # No necesita privileged
          allowPrivilegeEscalation: true
          capabilities:
            drop:
            - ALL
            add:
            - NET_ADMIN      # Requerido para configurar interfaces
            - NET_RAW        # Requerido para raw sockets
            - SYS_MODULE     # Requerido para cargar módulo wireguard
        
        # Variables de entorno
        env:
        - name: PUID
          value: "1000"
        - name: PGID
          value: "1000"
        - name: TZ
          value: "Europe/Madrid"
        - name: SERVERURL
          value: "auto"  # O especificar IP/dominio público
        - name: SERVERPORT
          value: "51820"
        - name: PEERS
          value: "0"  # No generar peers automáticamente
        - name: PEERDNS
          value: "10.8.0.1"
        - name: INTERNAL_SUBNET
          value: "10.8.0.0"
        - name: ALLOWEDIPS
          value: "10.8.0.0/24,10.43.0.0/16"  # VPN subnet + K8s subnet
        - name: LOG_CONFS
          value: "true"
        
        # Puertos
        ports:
        - name: wireguard
          containerPort: 51820
          protocol: UDP
        
        # Recursos
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
        
        # Probes
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - wg show wg0 | grep -q interface
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - test -f /config/wg0.conf && wg show wg0 | grep -q interface
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        
        # Volúmenes
        volumeMounts:
        - name: config
          mountPath: /config
        - name: wireguard-config
          mountPath: /config/templates
        - name: lib-modules
          mountPath: /lib/modules
          readOnly: true
        - name: scripts
          mountPath: /scripts
      
      volumes:
      - name: config
        persistentVolumeClaim:
          claimName: wireguard-config-pvc
      - name: wireguard-config
        configMap:
          name: wireguard-config
      - name: lib-modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: scripts
        configMap:
          name: wireguard-config
          defaultMode: 0755

---
# =============================================================================
# PersistentVolumeClaim para configuración
# =============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wireguard-config-pvc
  namespace: nekazari-vpn
  labels:
    app: wireguard
    component: vpn
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: local-path  # O tu StorageClass

---
# =============================================================================
# Service (NodePort/LoadBalancer)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: wireguard-service
  namespace: nekazari-vpn
  labels:
    app: wireguard
    component: vpn
spec:
  type: LoadBalancer  # Cambiar a NodePort si no hay LoadBalancer
  selector:
    app: wireguard
  ports:
  - name: wireguard
    port: 51820
    targetPort: 51820
    protocol: UDP
    # nodePort: 31820  # Descomentar si se usa NodePort
  
  # Configuración LoadBalancer (si aplica)
  # loadBalancerIP: YOUR_PUBLIC_IP
  externalTrafficPolicy: Local  # Preservar IP origen

---
# =============================================================================
# ServiceAccount para WireGuard
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wireguard-sa
  namespace: nekazari-vpn
  labels:
    app: wireguard
    component: vpn

---
# =============================================================================
# Role para WireGuard (permisos mínimos)
# =============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: wireguard-role
  namespace: nekazari-vpn
rules:
# Solo lectura de ConfigMaps y Secrets
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: wireguard-binding
  namespace: nekazari-vpn
subjects:
- kind: ServiceAccount
  name: wireguard-sa
  namespace: nekazari-vpn
roleRef:
  kind: Role
  name: wireguard-role
  apiGroup: rbac.authorization.k8s.io

---
# =============================================================================
# Job para inicializar WireGuard
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: wireguard-init
  namespace: nekazari-vpn
  labels:
    app: wireguard
    component: init
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init
        image: alpine:latest
        command:
        - sh
        - -c
        - |
          apk add --no-cache wireguard-tools
          
          echo "Generating WireGuard keys..."
          PRIVATE_KEY=$(wg genkey)
          PUBLIC_KEY=$(echo "$PRIVATE_KEY" | wg pubkey)
          
          echo "Private Key: $PRIVATE_KEY"
          echo "Public Key: $PUBLIC_KEY"
          echo ""
          echo "IMPORTANTE: Guardar estas claves y actualizar el Secret 'wireguard-keys'"
          echo ""
          echo "kubectl create secret generic wireguard-keys -n nekazari-vpn \\"
          echo "  --from-literal=private-key=\"$PRIVATE_KEY\" \\"
          echo "  --from-literal=public-key=\"$PUBLIC_KEY\" \\"
          echo "  --dry-run=client -o yaml | kubectl apply -f -"
