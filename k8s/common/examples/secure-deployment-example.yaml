# =============================================================================
# Ejemplo de Deployment Seguro con Security Context
# =============================================================================
# Este es un ejemplo de cómo deben configurarse TODOS los deployments
# con las mejores prácticas de seguridad aplicadas
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: nekazari
  labels:
    app: api-gateway
    layer: apis
    version: "1.0.0"
  annotations:
    description: "API Gateway con security context completo"
    security-level: "strict"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: api-gateway
  
  # Estrategia de actualización
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  template:
    metadata:
      labels:
        app: api-gateway
        layer: apis
        version: "1.0.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "5000"
        prometheus.io/path: "/metrics"
    
    spec:
      # ======================================================================
      # ServiceAccount específico (RBAC)
      # ======================================================================
      serviceAccountName: api-gateway-sa
      
      # ======================================================================
      # Security Context a nivel de Pod
      # ======================================================================
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      
      # ======================================================================
      # Contenedores
      # ======================================================================
      containers:
      - name: api-gateway
        image: nekazari/api-gateway:1.0.0
        imagePullPolicy: IfNotPresent
        
        # ==================================================================
        # Security Context a nivel de Contenedor
        # ==================================================================
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        
        # ==================================================================
        # Puertos
        # ==================================================================
        ports:
        - name: http
          containerPort: 5000
          protocol: TCP
        
        # ==================================================================
        # Variables de Entorno
        # ==================================================================
        env:
        # Desde ConfigMap
        - name: POSTGRES_URL
          valueFrom:
            configMapKeyRef:
              name: nekazari-config
              key: POSTGRESQL_URL
        
        - name: KEYCLOAK_URL
          valueFrom:
            configMapKeyRef:
              name: nekazari-config
              key: KEYCLOAK_URL
        
        # Desde Secrets
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: secret
        
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        
        # ==================================================================
        # Recursos (requests y limits)
        # ==================================================================
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        # ==================================================================
        # Probes (Health Checks)
        # ==================================================================
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /ready
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # ==================================================================
        # Volúmenes montados
        # ==================================================================
        volumeMounts:
        # Directorio temporal (readOnlyRootFilesystem = true requiere esto)
        - name: tmp
          mountPath: /tmp
        
        # Cache (si es necesario)
        - name: cache
          mountPath: /app/cache
        
        # Configuración adicional
        - name: config
          mountPath: /app/config
          readOnly: true
      
      # ======================================================================
      # Volúmenes
      # ======================================================================
      volumes:
      # emptyDir para /tmp (necesario con readOnlyRootFilesystem)
      - name: tmp
        emptyDir: {}
      
      # emptyDir para cache
      - name: cache
        emptyDir: {}
      
      # ConfigMap para configuración
      - name: config
        configMap:
          name: api-gateway-config
      
      # ======================================================================
      # Configuración adicional
      # ======================================================================
      # Tolerations para nodos específicos (si aplica)
      # tolerations:
      # - key: "workload-type"
      #   operator: "Equal"
      #   value: "api"
      #   effect: "NoSchedule"
      
      # Node Affinity (si aplica)
      # affinity:
      #   nodeAffinity:
      #     requiredDuringSchedulingIgnoredDuringExecution:
      #       nodeSelectorTerms:
      #       - matchExpressions:
      #         - key: workload-type
      #           operator: In
      #           values:
      #           - api
      #           - general

---
# =============================================================================
# Service correspondiente
# =============================================================================

apiVersion: v1
kind: Service
metadata:
  name: api-gateway-service
  namespace: nekazari
  labels:
    app: api-gateway
    layer: apis
spec:
  type: ClusterIP
  selector:
    app: api-gateway
  ports:
  - name: http
    port: 5000
    targetPort: http
    protocol: TCP
  sessionAffinity: ClientIP  # Mantener sesión en el mismo pod
