# =============================================================================
# Network Policies - Servicios Espec√≠ficos
# =============================================================================
# Pol√≠ticas de red detalladas para cada servicio de Nekazari
# Basadas en el principio de m√≠nimo privilegio
# =============================================================================

---
# =============================================================================
# 1. Nginx Ingress Controller - Puerta de Entrada üö™
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nginx-ingress-policy
  namespace: nekazari
  labels:
    app: nginx
    component: ingress-controller
    layer: reverse-proxy
spec:
  podSelector:
    matchLabels:
      app: nginx
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Acepta tr√°fico de Internet (cualquier origen)
  - from:
    - podSelector: {}  # Cualquier pod
    - namespaceSelector: {}  # Cualquier namespace
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  
  # Conexi√≥n a Orion Context Broker
  - to:
    - podSelector:
        matchLabels:
          app: orion-ld
    ports:
    - protocol: TCP
      port: 1026
  
  # Conexi√≥n a Grafana
  - to:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 3000
  
  # Conexi√≥n a Keycloak
  - to:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 8080
  
  # Conexi√≥n a Frontend
  - to:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 80
  
  # Conexi√≥n a API Gateway
  - to:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 5000
  
  # Conexi√≥n a Prometheus
  - to:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090

---
# =============================================================================
# 2. Orion Context Broker - Cerebro de FIWARE üß†
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: orion-ld-policy
  namespace: nekazari
  labels:
    app: orion-ld
    component: context-broker
    layer: apis
spec:
  podSelector:
    matchLabels:
      app: orion-ld
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Desde Nginx Ingress Controller
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 1026
  
  # Desde API Gateway
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 1026
  
  # Desde Entity Manager
  - from:
    - podSelector:
        matchLabels:
          app: entity-manager
    ports:
    - protocol: TCP
      port: 1026
  
  # Desde Agentes IoT (cuando se a√±adan)
  - from:
    - podSelector:
        matchLabels:
          component: iot-agent
    ports:
    - protocol: TCP
      port: 1026
  
  # Desde ROS2 Bridge (cuando se a√±ada)
  - from:
    - podSelector:
        matchLabels:
          app: ros2-bridge
    ports:
    - protocol: TCP
      port: 1026
  
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  
  # Conexi√≥n a MongoDB
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  
  # Conexi√≥n a Mosquitto (para notificaciones)
  - to:
    - podSelector:
        matchLabels:
          app: mosquitto
    ports:
    - protocol: TCP
      port: 1883
  
  # Conexi√≥n a Keycloak (validaci√≥n de tokens)
  - to:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 8080

---
# =============================================================================
# 3. Mosquitto - Broker MQTT üì°
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mosquitto-policy
  namespace: nekazari
  labels:
    app: mosquitto
    component: mqtt-broker
    layer: apis
spec:
  podSelector:
    matchLabels:
      app: mosquitto
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Desde Orion Context Broker (notificaciones)
  - from:
    - podSelector:
        matchLabels:
          app: orion-ld
    ports:
    - protocol: TCP
      port: 1883
  
  # Desde Agentes IoT
  - from:
    - podSelector:
        matchLabels:
          component: iot-agent
    ports:
    - protocol: TCP
      port: 1883
    - protocol: TCP
      port: 8883  # MQTT SSL
  
  # Desde ROS2 Bridge
  - from:
    - podSelector:
        matchLabels:
          app: ros2-bridge
    ports:
    - protocol: TCP
      port: 1883
  
  # Desde aplicaciones externas v√≠a VPN (WireGuard)
  # Esto se gestiona a nivel de servicio LoadBalancer/NodePort
  - from:
    - podSelector:
        matchLabels:
          app: wireguard
    ports:
    - protocol: TCP
      port: 1883
    - protocol: TCP
      port: 8883
  
  # WebSocket para clientes web
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 9001
  
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  
  # Solo necesita DNS, no inicia conexiones (modo bridge deshabilitado)

---
# =============================================================================
# 4. Prometheus - Sistema de Monitorizaci√≥n üìä
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-policy
  namespace: nekazari
  labels:
    app: prometheus
    component: monitoring
    layer: monitoring
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Desde Grafana (consultas)
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 9090
  
  # Desde Nginx (acceso web)
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 9090
  
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  
  # Scraping: Puede conectarse a TODOS los servicios en puerto /metrics
  # Orion Context Broker
  - to:
    - podSelector:
        matchLabels:
          app: orion-ld
    ports:
    - protocol: TCP
      port: 1026  # Endpoint /metrics
  
  # Nginx
  - to:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 9113  # nginx-exporter
  
  # Mosquitto
  - to:
    - podSelector:
        matchLabels:
          app: mosquitto
    ports:
    - protocol: TCP
      port: 9234  # mosquitto-exporter
  
  # Keycloak
  - to:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 8080  # /metrics
  
  # PostgreSQL Exporter
  - to:
    - podSelector:
        matchLabels:
          app: postgresql-exporter
    ports:
    - protocol: TCP
      port: 9187
  
  # MongoDB Exporter
  - to:
    - podSelector:
        matchLabels:
          app: mongodb-exporter
    ports:
    - protocol: TCP
      port: 9216
  
  # Node Exporter
  - to:
    - podSelector:
        matchLabels:
          app: node-exporter
    ports:
    - protocol: TCP
      port: 9100
  
  # cAdvisor
  - to:
    - podSelector:
        matchLabels:
          app: cadvisor
    ports:
    - protocol: TCP
      port: 8080
  
  # APIs propias
  - to:
    - podSelector:
        matchLabels:
          layer: apis
    ports:
    - protocol: TCP
      port: 5000  # M√©tricas en /metrics

---
# =============================================================================
# 5. Grafana - Visualizaci√≥n üìà
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-policy
  namespace: nekazari
  labels:
    app: grafana
    component: monitoring
    layer: monitoring
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Desde Nginx (acceso web)
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 80
  
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  
  # Conexi√≥n a Prometheus
  - to:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
  
  # Conexi√≥n a Keycloak (autenticaci√≥n)
  - to:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 8080
  
  # Conexi√≥n a PostgreSQL (datasource)
  - to:
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432
  
  # Conexi√≥n a TimescaleDB (datasource)
  - to:
    - podSelector:
        matchLabels:
          app: timescaledb
    ports:
    - protocol: TCP
      port: 5432

---
# =============================================================================
# 6. Keycloak - Gesti√≥n de Identidad üîê
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: keycloak-policy
  namespace: nekazari
  labels:
    app: keycloak
    component: identity-management
    layer: auth
spec:
  podSelector:
    matchLabels:
      app: keycloak
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Desde Nginx (interfaz web y API)
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8080
  
  # Desde todos los servicios que validan tokens
  - from:
    - podSelector:
        matchLabels:
          layer: apis
    ports:
    - protocol: TCP
      port: 8080
  
  - from:
    - podSelector:
        matchLabels:
          app: orion-ld
    ports:
    - protocol: TCP
      port: 8080
  
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 8080
  
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  
  # Conexi√≥n a PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432

---
# =============================================================================
# 7. PostgreSQL - Base de Datos üóÑÔ∏è
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql-policy
  namespace: nekazari
  labels:
    app: postgresql
    component: database
    layer: database
spec:
  podSelector:
    matchLabels:
      app: postgresql
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Solo desde Keycloak
  - from:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 5432
  
  # Desde Grafana (datasource)
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 5432
  
  # Desde APIs que usan PostgreSQL
  - from:
    - podSelector:
        matchLabels:
          app: api-validator
    ports:
    - protocol: TCP
      port: 5432
  
  - from:
    - podSelector:
        matchLabels:
          app: activation-codes
    ports:
    - protocol: TCP
      port: 5432
  
  # Desde PostgreSQL Exporter (m√©tricas)
  - from:
    - podSelector:
        matchLabels:
          app: postgresql-exporter
    ports:
    - protocol: TCP
      port: 5432
  
  egress:
  # PostgreSQL generalmente no necesita egress
  # Solo DNS para posible replicaci√≥n
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# =============================================================================
# 8. MongoDB - Base de Datos de Orion üçÉ
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-policy
  namespace: nekazari
  labels:
    app: mongodb
    component: database
    layer: database
spec:
  podSelector:
    matchLabels:
      app: mongodb
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # SOLO desde Orion Context Broker
  - from:
    - podSelector:
        matchLabels:
          app: orion-ld
    ports:
    - protocol: TCP
      port: 27017
  
  # Desde MongoDB Exporter (m√©tricas)
  - from:
    - podSelector:
        matchLabels:
          app: mongodb-exporter
    ports:
    - protocol: TCP
      port: 27017
  
  egress:
  # MongoDB generalmente no necesita egress
  # Solo DNS para posible replicaci√≥n
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# =============================================================================
# 9. API Gateway - Gateway de APIs üöÄ
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-policy
  namespace: nekazari
  labels:
    app: api-gateway
    component: gateway
    layer: apis
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Desde Nginx
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 5000
  
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Acceso a PyPI para instalar dependencias Python
  - to: []
    ports:
    - protocol: TCP
      port: 443  # HTTPS para PyPI
    - protocol: TCP
      port: 80   # HTTP para PyPI (redirecci√≥n)
  
  # Puede conectarse a todos los servicios backend
  - to:
    - podSelector:
        matchLabels:
          layer: apis
    ports:
    - protocol: TCP
      port: 5000
  
  - to:
    - podSelector:
        matchLabels:
          app: orion-ld
    ports:
    - protocol: TCP
      port: 1026
  
  - to:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 8080

---
# =============================================================================
# 10. Servicios de APIs (API Validator, Farmer Auth, etc.)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: apis-layer-policy
  namespace: nekazari
  labels:
    layer: apis
    component: microservices
spec:
  podSelector:
    matchLabels:
      layer: apis
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Desde API Gateway
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 5000
  
  # Desde Nginx (directo)
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 5000
  
  # Entre ellos mismos
  - from:
    - podSelector:
        matchLabels:
          layer: apis
    ports:
    - protocol: TCP
      port: 5000
  
  # Desde Prometheus (m√©tricas)
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 5000
  
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Acceso a PyPI para instalar dependencias Python
  - to: []
    ports:
    - protocol: TCP
      port: 443  # HTTPS para PyPI
    - protocol: TCP
      port: 80   # HTTP para PyPI (redirecci√≥n)
  
  # PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432
  
  # Keycloak (validaci√≥n)
  - to:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 8080
  
  # Orion
  - to:
    - podSelector:
        matchLabels:
          app: orion-ld
    ports:
    - protocol: TCP
      port: 1026
  
  # Entre APIs
  - to:
    - podSelector:
        matchLabels:
          layer: apis
    ports:
    - protocol: TCP
      port: 5000
