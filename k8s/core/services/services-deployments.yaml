# =============================================================================
# Core API Services Deployments - Nekazari
# =============================================================================
# Servicios CORE esenciales para la operación básica de la plataforma
# Incluye: API Gateway, Entity Manager
# =============================================================================

---
# API Gateway
# Punto de entrada único para todas las APIs
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: nekazari
  labels:
    app: api-gateway
    layer: core
    component: api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
        layer: core
        component: api
    spec:
      serviceAccountName: api-gateway-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: api-gateway
          image: ghcr.io/k8-benetis/nkz/api-gateway:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          ports:
            - containerPort: 5000
          env:
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: secret
            - name: HMAC_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: secret
            - name: ORION_URL
              value: http://orion-ld-service:1026
            - name: KEYCLOAK_URL
              value: http://keycloak-service:8080/auth
            - name: KEYCLOAK_PUBLIC_URL
              valueFrom:
                configMapKeyRef:
                  name: nekazari-config
                  key: KEYCLOAK_PUBLIC_URL
            - name: KEYCLOAK_HOSTNAME
              valueFrom:
                configMapKeyRef:
                  name: nekazari-config
                  key: KEYCLOAK_HOSTNAME
            - name: KEYCLOAK_REALM
              value: "nekazari"
            - name: CONTEXT_URL
              valueFrom:
                configMapKeyRef:
                  name: nekazari-config
                  key: CONTEXT_URL
            - name: ALLOW_JWT_FALLBACK
              value: "false"
            - name: GEOSERVER_URL
              value: http://geoserver-service:8080
            - name: TENANT_WEBHOOK_URL
              value: http://tenant-webhook-service:8080
            - name: NDVI_SERVICE_URL
              value: http://entity-manager-service:5000
            - name: ENTITY_MANAGER_URL
              value: http://entity-manager-service:5000
          command: ["gunicorn"]
          args:
            [
              "--bind",
              "0.0.0.0:5000",
              "--workers",
              "2",
              "--threads",
              "2",
              "--timeout",
              "60",
              "--access-logfile",
              "-",
              "--error-logfile",
              "-",
              "fiware_api_gateway:app",
            ]
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "100m"

---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway-service
  namespace: nekazari
  labels:
    app: api-gateway
    layer: core
spec:
  selector:
    app: api-gateway
  ports:
    - port: 5000
      targetPort: 5000

---
# Entity Manager
# Gestión de entidades NGSI-LD (Digital Twins)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: entity-manager
  namespace: nekazari
  labels:
    app: entity-manager
    layer: core
    component: api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: entity-manager
  template:
    metadata:
      labels:
        app: entity-manager
        layer: core
        component: api
    spec:
      serviceAccountName: entity-manager-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: entity-manager
          image: ghcr.io/k8-benetis/nkz/entity-manager:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          ports:
            - containerPort: 5000
          env:
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: secret
            - name: HMAC_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: secret
            - name: ALLOW_JWT_FALLBACK
              value: "false"
            - name: REQUIRE_HMAC_SIGNATURE
              value: "true"
            - name: ORION_URL
              value: http://orion-ld-service:1026
            - name: KEYCLOAK_URL
              value: http://keycloak-service:8080
            - name: KEYCLOAK_PUBLIC_URL
              valueFrom:
                configMapKeyRef:
                  name: nekazari-config
                  key: KEYCLOAK_PUBLIC_URL
                  optional: true
            - name: KEYCLOAK_HOSTNAME
              valueFrom:
                configMapKeyRef:
                  name: nekazari-config
                  key: KEYCLOAK_HOSTNAME
                  optional: true
            - name: KEYCLOAK_REALM
              value: "nekazari"
            - name: GRAFANA_OAUTH_CLIENT_ID
              value: "nekazari-frontend"
            - name: PRODUCTION_DOMAIN
              valueFrom:
                configMapKeyRef:
                  name: nekazari-config
                  key: PRODUCTION_DOMAIN
            - name: POSTGRES_URL
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: postgres-url
            - name: NDVI_QUEUE_NAME
              value: "ndvi"
            - name: REDIS_URL
              value: "redis://redis-service:6379/0"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-secret
                  key: password
                  optional: true
            - name: GRAFANA_URL
              value: http://grafana-service:3000
            - name: GRAFANA_ADMIN_USER
              value: admin
            - name: GRAFANA_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-secret
                  key: admin-password
            - name: MQTT_HOST
              value: mosquitto-service
            - name: MQTT_PORT
              value: "1883"
            - name: MQTT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mosquitto-credentials
                  key: iot-agent-username
                  optional: true
            - name: MQTT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mosquitto-credentials
                  key: iot-agent-password
                  optional: true
            - name: BLOB_READ_WRITE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vercel-blob-secret
                  key: blob-read-write-token
                  optional: true
            - name: S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secret
                  key: root-user
            - name: S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secret
                  key: root-password
            - name: S3_ENDPOINT_URL
              value: "http://minio-service:9000"
            - name: ASSETS_BUCKET
              value: "assets-3d"
            - name: ASSETS_PUBLIC_URL
              value: "https://nekazari.robotika.cloud/assets"
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "100m"

---
apiVersion: v1
kind: Service
metadata:
  name: entity-manager-service
  namespace: nekazari
  labels:
    app: entity-manager
    layer: core
spec:
  selector:
    app: entity-manager
  ports:
    - port: 5000
      targetPort: 5000
