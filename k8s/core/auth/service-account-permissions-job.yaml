# =============================================================================
# Keycloak Service Account Permissions Setup Job
# =============================================================================
# This job assigns the realm-admin role to the Service Account of the
# nekazari-api-gateway client, allowing it to create users in Keycloak.
# 
# This Job is automatically executed after Keycloak deployment to ensure
# the Service Account has the necessary permissions. It is idempotent and
# can be run multiple times safely.
# =============================================================================

---
apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-service-account-permissions
  namespace: nekazari
  labels:
    app: keycloak
    component: service-account-setup
  annotations:
    # This annotation allows the Job to be recreated if it already exists
    # Useful for re-running after Keycloak redeployment
    "job.nekazari.io/auto-cleanup": "true"
spec:
  # TTL after completion: 1 hour (allows inspection of logs if needed)
  ttlSecondsAfterFinished: 3600
  # Backoff limit: allow 3 retries if job fails
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: keycloak-service-account-permissions
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-keycloak
          image: curlimages/curl:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Waiting for Keycloak to be ready..."
              MAX_WAIT=60
              WAIT_COUNT=0
              until curl -f -s http://keycloak-service:8080/auth/realms/master > /dev/null 2>&1 || curl -f -s http://keycloak-service:8080/realms/master > /dev/null 2>&1; do
                if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
                  echo "ERROR: Keycloak did not become ready after $MAX_WAIT attempts"
                  exit 1
                fi
                echo "Keycloak not ready yet, waiting... (attempt $((WAIT_COUNT+1))/$MAX_WAIT)"
                sleep 5
                WAIT_COUNT=$((WAIT_COUNT+1))
              done
              echo "Keycloak is ready."
      containers:
        - name: setup-permissions
          image: quay.io/keycloak/keycloak:26.4.1
          env:
            - name: KEYCLOAK_ADMIN
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: admin-username
            - name: KEYCLOAK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: admin-password
            - name: KEYCLOAK_URL
              value: "http://keycloak-service:8080/auth"
            - name: KEYCLOAK_REALM
              value: "nekazari"
            - name: CLIENT_ID
              value: "nekazari-api-gateway"
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              
              echo "Keycloak is ready, setting up Service Account permissions..."
              
              # Wait a bit more for Keycloak to be fully ready
              sleep 10
              
              # Configure kcadm.sh credentials
              echo "Configuring kcadm.sh credentials..."
              # Try multiple times as Keycloak might need a moment to be fully ready
              for i in 1 2 3; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --server "${KEYCLOAK_URL}" \
                  --realm master \
                  --user "${KEYCLOAK_ADMIN}" \
                  --password "${KEYCLOAK_ADMIN_PASSWORD}" 2>/dev/null; then
                  echo "✓ Credentials configured successfully"
                  break
                else
                  if [ $i -eq 3 ]; then
                    echo "ERROR: Failed to configure credentials after 3 attempts"
                    echo "Trying to verify Keycloak is accessible..."
                    curl -f -s "${KEYCLOAK_URL}/realms/master" > /dev/null || echo "Keycloak not accessible at ${KEYCLOAK_URL}"
                    exit 1
                  fi
                  echo "Attempt $i failed, retrying in 5 seconds..."
                  sleep 5
                fi
              done
              
              # Verify realm exists first
              echo "Verifying realm ${KEYCLOAK_REALM} exists..."
              # The CSV format is: id,realm,name,... so we need to check the second column
              # Use cut instead of awk (awk not available in Keycloak image)
              REALM_EXISTS=$(/opt/keycloak/bin/kcadm.sh get realms \
                --format csv \
                --noquotes 2>/dev/null | cut -d',' -f2 | grep -i "^${KEYCLOAK_REALM}$" || echo "")
              
              if [ -z "$REALM_EXISTS" ]; then
                echo "WARNING: Realm ${KEYCLOAK_REALM} not found!"
                echo "Available realms:"
                /opt/keycloak/bin/kcadm.sh get realms --format csv --noquotes 2>/dev/null | while IFS=',' read -r id realm rest; do
                  echo "  - $realm (ID: $id)"
                done | head -10
                echo ""
                echo "ERROR: Realm ${KEYCLOAK_REALM} must exist before setting up Service Account permissions"
                echo "Please run the realm-import-job first or create the realm manually"
                exit 1
              fi
              
              echo "✓ Realm ${KEYCLOAK_REALM} exists"
              
              # Get client ID
              echo "Getting client ID for ${CLIENT_ID}..."
              CLIENT_UUID=$(/opt/keycloak/bin/kcadm.sh get clients \
                --realm "${KEYCLOAK_REALM}" \
                --fields id,clientId \
                --format csv \
                --noquotes 2>/dev/null | grep "${CLIENT_ID}" | cut -d',' -f1) || {
                echo "ERROR: Failed to get client ID for ${CLIENT_ID}"
                echo "Available clients in realm ${KEYCLOAK_REALM}:"
                /opt/keycloak/bin/kcadm.sh get clients --realm "${KEYCLOAK_REALM}" --fields clientId --format csv --noquotes 2>/dev/null | head -10
                exit 1
              }
              
              if [ -z "$CLIENT_UUID" ]; then
                echo "WARNING: Client ${CLIENT_ID} not found in realm ${KEYCLOAK_REALM}"
                echo "Available clients:"
                /opt/keycloak/bin/kcadm.sh get clients --realm "${KEYCLOAK_REALM}" --fields clientId --format csv --noquotes 2>/dev/null | head -10
                echo ""
                echo "Creating client ${CLIENT_ID}..."
                # Reconfigure credentials to ensure they're still valid
                echo "Reconfiguring credentials before creating client..."
                /opt/keycloak/bin/kcadm.sh config credentials \
                  --server "${KEYCLOAK_URL}" \
                  --realm master \
                  --user "${KEYCLOAK_ADMIN}" \
                  --password "${KEYCLOAK_ADMIN_PASSWORD}" 2>&1
                
                # Create the client with Service Account enabled
                echo "Executing client creation command..."
                CREATE_RESULT=$(/opt/keycloak/bin/kcadm.sh create clients \
                  --realm "${KEYCLOAK_REALM}" \
                  -s clientId="${CLIENT_ID}" \
                  -s name="Nekazari API Gateway" \
                  -s description="API Gateway service for Nekazari platform" \
                  -s enabled=true \
                  -s clientAuthenticatorType="client-secret" \
                  -s serviceAccountsEnabled=true \
                  -s protocol="openid-connect" \
                  -s fullScopeAllowed=true 2>&1)
                
                CREATE_EXIT_CODE=$?
                echo "Create command exit code: $CREATE_EXIT_CODE"
                echo "Create command output: $CREATE_RESULT"
                
                if [ $CREATE_EXIT_CODE -eq 0 ]; then
                  echo "✓ Client ${CLIENT_ID} created successfully"
                  # Reconfigure credentials again before getting client UUID
                  /opt/keycloak/bin/kcadm.sh config credentials \
                    --server "${KEYCLOAK_URL}" \
                    --realm master \
                    --user "${KEYCLOAK_ADMIN}" \
                    --password "${KEYCLOAK_ADMIN_PASSWORD}" >/dev/null 2>&1
                  
                  # Get the newly created client UUID
                  CLIENT_UUID=$(/opt/keycloak/bin/kcadm.sh get clients \
                    --realm "${KEYCLOAK_REALM}" \
                    --fields id,clientId \
                    --format csv \
                    --noquotes 2>/dev/null | grep "${CLIENT_ID}" | cut -d',' -f1)
                  
                  if [ -z "$CLIENT_UUID" ]; then
                    echo "ERROR: Failed to get UUID of newly created client"
                    echo "Create result: $CREATE_RESULT"
                    exit 1
                  fi
                else
                  echo "ERROR: Failed to create client ${CLIENT_ID}"
                  echo "Error output: $CREATE_RESULT"
                  echo "Exit code: $CREATE_EXIT_CODE"
                  exit 1
                fi
              fi
              
              echo "Found client UUID: ${CLIENT_UUID}"
              
              # Get Service Account User ID
              echo "Getting Service Account User ID..."
              SERVICE_ACCOUNT_USER_ID=$(/opt/keycloak/bin/kcadm.sh get \
                "clients/${CLIENT_UUID}/service-account-user" \
                --realm "${KEYCLOAK_REALM}" \
                --fields id \
                --format csv \
                --noquotes 2>/dev/null | cut -d',' -f1) || {
                echo "ERROR: Failed to get Service Account User ID"
                exit 1
              }
              
              if [ -z "$SERVICE_ACCOUNT_USER_ID" ]; then
                echo "ERROR: Service Account User not found for client ${CLIENT_ID}"
                exit 1
              fi
              
              echo "Found Service Account User ID: ${SERVICE_ACCOUNT_USER_ID}"
              
              # Get realm-admin role ID
              echo "Getting realm-admin role ID..."
              REALM_ADMIN_ROLE_ID=$(/opt/keycloak/bin/kcadm.sh get roles \
                --realm "${KEYCLOAK_REALM}" \
                --fields id,name \
                --format csv \
                --noquotes 2>/dev/null | grep "realm-admin" | cut -d',' -f1) || {
                echo "ERROR: Failed to get realm-admin role ID"
                exit 1
              }
              
              if [ -z "$REALM_ADMIN_ROLE_ID" ]; then
                echo "ERROR: realm-admin role not found in realm ${KEYCLOAK_REALM}"
                exit 1
              fi
              
              echo "Found realm-admin role ID: ${REALM_ADMIN_ROLE_ID}"
              
              # Check if role is already assigned
              echo "Checking if realm-admin role is already assigned..."
              EXISTING_ROLES=$(/opt/keycloak/bin/kcadm.sh get \
                "users/${SERVICE_ACCOUNT_USER_ID}/role-mappings/realm" \
                --realm "${KEYCLOAK_REALM}" \
                --fields id \
                --format csv \
                --noquotes 2>/dev/null | grep "${REALM_ADMIN_ROLE_ID}" || true)
              
              if [ -n "$EXISTING_ROLES" ]; then
                echo "✓ realm-admin role is already assigned to Service Account"
                exit 0
              fi
              
              # Assign realm-admin role to Service Account User
              echo "Assigning realm-admin role to Service Account User..."
              /opt/keycloak/bin/kcadm.sh add-roles \
                --realm "${KEYCLOAK_REALM}" \
                --uusername "service-account-${CLIENT_ID}" \
                --rolename "realm-admin" || {
                echo "ERROR: Failed to assign realm-admin role"
                echo "Trying alternative method using user ID..."
                # Alternative: use user ID directly
                /opt/keycloak/bin/kcadm.sh create \
                  "users/${SERVICE_ACCOUNT_USER_ID}/role-mappings/realm" \
                  --realm "${KEYCLOAK_REALM}" \
                  -s id="${REALM_ADMIN_ROLE_ID}" \
                  -s name="realm-admin" || {
                  echo "ERROR: Failed to assign role using alternative method"
                  exit 1
                }
              }
              
              echo "✓ Successfully assigned realm-admin role to Service Account"
              echo "✓ Service Account can now create users in Keycloak"

