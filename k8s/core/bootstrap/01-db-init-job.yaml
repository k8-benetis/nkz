apiVersion: v1
kind: ConfigMap
metadata:
  name: db-schema-config
  namespace: nekazari
data:
  001_complete_schema.sql: |
    -- Copy content of config/timescaledb/migrations/001_complete_schema.sql here
    -- (Content omitted for brevity in this template, user should populate it)
---
apiVersion: batch/v1
kind: Job
metadata:
  name: db-init-job
  namespace: nekazari
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
      - name: db-init
        image: postgres:14-alpine
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        command: ["psql", "-h", "postgresql-service", "-U", "postgres", "-d", "nekazari", "-f", "/scripts/001_complete_schema.sql"]
        volumeMounts:
        - name: schema-script
          mountPath: /scripts
      volumes:
      - name: schema-script
        configMap:
          name: db-schema-config
      restartPolicy: OnFailure
