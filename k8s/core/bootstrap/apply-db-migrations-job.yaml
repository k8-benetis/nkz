apiVersion: batch/v1
kind: Job
metadata:
  name: apply-db-migrations
  namespace: nekazari
  labels:
    app: nekazari
    component: database-migrations
spec:
  template:
    metadata:
      labels:
        app: apply-db-migrations
    spec:
      restartPolicy: OnFailure
      containers:
      - name: migrations
        image: postgres:15
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "üîß Applying database migrations..."
          
          # Wait for PostgreSQL to be ready
          until pg_isready -h $POSTGRES_HOST -U $POSTGRES_USER -d $POSTGRES_DB; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          
          # Apply migrations in order
          for migration in /migrations/010_sensor_ingestion_schema.sql /migrations/011_weather_module_agroclimatic_intelligence.sql; do
            if [ -f "$migration" ]; then
              echo "üìÑ Applying: $(basename $migration)"
              psql -h $POSTGRES_HOST -U $POSTGRES_USER -d $POSTGRES_DB -f "$migration" || {
                echo "‚ö†Ô∏è  Migration $(basename $migration) had errors (may be expected if already applied)"
              }
            else
              echo "‚ö†Ô∏è  Migration file not found: $migration"
            fi
          done
          
          echo "‚úÖ Migrations completed"
          
          # Verify critical tables
          echo ""
          echo "üîç Verifying critical tables..."
          psql -h $POSTGRES_HOST -U $POSTGRES_USER -d $POSTGRES_DB -c "
            SELECT 
              CASE WHEN EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'catalog_municipalities') 
              THEN '‚úÖ catalog_municipalities exists' 
              ELSE '‚ùå catalog_municipalities MISSING' 
              END as status;
          "
        env:
        - name: POSTGRES_DB
          valueFrom:
            configMapKeyRef:
              name: nekazari-config
              key: POSTGRES_DB
        - name: POSTGRES_USER
          valueFrom:
            configMapKeyRef:
              name: nekazari-config
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        - name: POSTGRES_HOST
          value: postgresql-service
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        volumeMounts:
        - name: migrations-vol
          mountPath: /migrations
      volumes:
      - name: migrations-vol
        configMap:
          name: db-migrations
          defaultMode: 0644

