# =============================================================================
# CronJob para Limpieza de Audit Logs
# =============================================================================
# Este CronJob limpia logs de auditoría más antiguos de 90 días
# Ejecuta cada día a las 2 AM
apiVersion: batch/v1
kind: CronJob
metadata:
  name: audit-logs-cleanup
  namespace: nekazari
  labels:
    app: audit-logs
    component: cleanup
spec:
  # Ejecutar cada día a las 2 AM: 0 2 * * *
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid  # No ejecutar si el anterior aún está corriendo
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: audit-logs
            component: cleanup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: cleanup
            image: postgres:15-alpine
            command:
            - /bin/sh
            - -c
            - |
              set -e
              
              echo "=========================================="
              echo "Iniciando limpieza de audit logs"
              echo "Fecha: $(date)"
              echo "=========================================="
              
              # Variables de PostgreSQL
              PG_HOST="${PG_HOST:-postgresql-service}"
              PG_PORT="${PG_PORT:-5432}"
              PG_USER="${PG_USER:-timescale}"
              PG_PASSWORD="${PG_PASSWORD}"
              PG_DATABASE="${PG_DATABASE:-fiware_history}"
              
              # Retención en días (default: 90)
              RETENTION_DAYS="${RETENTION_DAYS:-90}"
              
              # Verificar que las variables críticas estén definidas
              if [ -z "$PG_PASSWORD" ]; then
                echo "ERROR: Contraseña de PostgreSQL no configurada"
                exit 1
              fi
              
              # Exportar contraseña para psql
              export PGPASSWORD="${PG_PASSWORD}"
              
              # Esperar a que PostgreSQL esté listo
              echo "Esperando a que PostgreSQL esté listo..."
              for i in $(seq 1 30); do
                if pg_isready -h "${PG_HOST}" -p "${PG_PORT}" -U "${PG_USER}" >/dev/null 2>&1; then
                  echo "PostgreSQL está listo"
                  break
                fi
                if [ $i -eq 30 ]; then
                  echo "ERROR: PostgreSQL no está disponible después de 60 segundos"
                  exit 1
                fi
                echo "Esperando... ($i/30)"
                sleep 2
              done
              
              # Verificar que la tabla existe
              echo "Verificando que la tabla sys_audit_logs existe..."
              TABLE_EXISTS=$(psql -h "${PG_HOST}" -p "${PG_PORT}" -U "${PG_USER}" -d "${PG_DATABASE}" -t -c "
                SELECT EXISTS (
                  SELECT FROM information_schema.tables 
                  WHERE table_schema = 'public' 
                  AND table_name = 'sys_audit_logs'
                );
              " | tr -d ' ')
              
              if [ "$TABLE_EXISTS" != "t" ]; then
                echo "WARNING: La tabla sys_audit_logs no existe. Saltando limpieza."
                exit 0
              fi
              
              # Contar registros antes de limpiar
              echo "Contando registros antes de limpiar..."
              COUNT_BEFORE=$(psql -h "${PG_HOST}" -p "${PG_PORT}" -U "${PG_USER}" -d "${PG_DATABASE}" -t -c "
                SELECT COUNT(*) FROM sys_audit_logs;
              " | tr -d ' ')
              
              echo "Registros totales: ${COUNT_BEFORE}"
              
              # Contar registros que serán eliminados
              COUNT_TO_DELETE=$(psql -h "${PG_HOST}" -p "${PG_PORT}" -U "${PG_USER}" -d "${PG_DATABASE}" -t -c "
                SELECT COUNT(*) FROM sys_audit_logs 
                WHERE created_at < NOW() - INTERVAL '${RETENTION_DAYS} days';
              " | tr -d ' ')
              
              echo "Registros a eliminar (más antiguos de ${RETENTION_DAYS} días): ${COUNT_TO_DELETE}"
              
              if [ "$COUNT_TO_DELETE" = "0" ]; then
                echo "No hay registros antiguos para eliminar. Limpieza completada."
                exit 0
              fi
              
              # Eliminar registros antiguos
              echo "Eliminando registros antiguos..."
              psql -h "${PG_HOST}" -p "${PG_PORT}" -U "${PG_USER}" -d "${PG_DATABASE}" -c "
                DELETE FROM sys_audit_logs 
                WHERE created_at < NOW() - INTERVAL '${RETENTION_DAYS} days';
              "
              
              # Verificar resultado
              if [ $? -eq 0 ]; then
                echo "✅ Limpieza completada exitosamente"
                
                # Contar registros después de limpiar
                COUNT_AFTER=$(psql -h "${PG_HOST}" -p "${PG_PORT}" -U "${PG_USER}" -d "${PG_DATABASE}" -t -c "
                  SELECT COUNT(*) FROM sys_audit_logs;
                " | tr -d ' ')
                
                echo "Registros restantes: ${COUNT_AFTER}"
                echo "Registros eliminados: ${COUNT_TO_DELETE}"
              else
                echo "❌ ERROR: Fallo al eliminar registros"
                exit 1
              fi
              
              # Vacuum para liberar espacio
              echo "Ejecutando VACUUM para liberar espacio..."
              psql -h "${PG_HOST}" -p "${PG_PORT}" -U "${PG_USER}" -d "${PG_DATABASE}" -c "
                VACUUM ANALYZE sys_audit_logs;
              "
              
              echo "=========================================="
              echo "Limpieza de audit logs completada"
              echo "Fecha: $(date)"
              echo "=========================================="
            env:
            - name: PG_HOST
              value: "postgresql-service"
            - name: PG_PORT
              value: "5432"
            - name: PG_USER
              value: "timescale"
            - name: PG_DATABASE
              value: "fiware_history"
            - name: PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: password
            - name: RETENTION_DAYS
              value: "90"  # Retención de 90 días (configurable)
            resources:
              requests:
                memory: "128Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "200m"

