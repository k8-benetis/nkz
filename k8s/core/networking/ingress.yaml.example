# Ingress template for Nekazari - Traefik (K3s default)
# =============================================================================
# Copy to ingress.yaml and replace your-domain.com with your actual domain.
# The real ingress.yaml is not tracked in git (server-specific; repo is public).
# TLS: use cert-manager or your wildcard secret for *.your-domain.com.
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nekazari-ingress
  namespace: nekazari
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.middlewares: nekazari-nekazari-cors@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - nekazari.your-domain.com
      secretName: nekazari-tls
    - hosts:
        - nkz.your-domain.com
      secretName: nkz-tls
    # Odoo: use the module ingress (odoo-direct-ingress) only; do not add odoo host here.

  rules:
    - host: nkz.your-domain.com
      http:
        paths:
          - path: /api/modules
            pathType: Prefix
            backend:
              service:
                name: entity-manager-service
                port:
                  number: 5000
          - path: /api/assets
            pathType: Prefix
            backend:
              service:
                name: entity-manager-service
                port:
                  number: 5000
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: api-gateway-service
                port:
                  number: 5000
          - path: /ngsi-ld
            pathType: Prefix
            backend:
              service:
                name: api-gateway-service
                port:
                  number: 5000
          - path: /api/tenant/users
            pathType: Prefix
            backend:
              service:
                name: tenant-user-api-service
                port:
                  number: 5000
          - path: /api/tenant/services
            pathType: Prefix
            backend:
              service:
                name: tenant-webhook-service
                port:
                  number: 8080
          - path: /webhook
            pathType: Prefix
            backend:
              service:
                name: tenant-webhook-service
                port:
                  number: 8080
          - path: /admin
            pathType: Prefix
            backend:
              service:
                name: tenant-webhook-service
                port:
                  number: 8080
          - path: /forgot-password
            pathType: Exact
            backend:
              service:
                name: tenant-webhook-service
                port:
                  number: 8080
          - path: /iot/http
            pathType: Prefix
            backend:
              service:
                name: iot-agent-json-service
                port:
                  number: 7896
          - path: /api/connectivity
            pathType: Prefix
            backend:
              service:
                name: connectivity-api-service
                port:
                  number: 8000
          - path: /sdm
            pathType: Prefix
            backend:
              service:
                name: sdm-integration-service
                port:
                  number: 5000
          - path: /grafana
            pathType: Prefix
            backend:
              service:
                name: grafana-service
                port:
                  number: 3000
          - path: /n8n
            pathType: Prefix
            backend:
              service:
                name: n8n-service
                port:
                  number: 5678
          - path: /titiler
            pathType: Prefix
            backend:
              service:
                name: titiler-service
                port:
                  number: 8000
          - path: /entity-manager
            pathType: Prefix
            backend:
              service:
                name: entity-manager-service
                port:
                  number: 5000
          - path: /ndvi
            pathType: Prefix
            backend:
              service:
                name: entity-manager-service
                port:
                  number: 5000
          - path: /api/vegetation
            pathType: Prefix
            backend:
              service:
                name: vegetation-prime-api-service
                port:
                  number: 8000
          - path: /api/intelligence
            pathType: Prefix
            backend:
              service:
                name: intelligence-api-service
                port:
                  number: 8000
          - path: /api/cadastral-api
            pathType: Prefix
            backend:
              service:
                name: catastro-spain-api-service
                port:
                  number: 5000
          - path: /api/lidar
            pathType: Prefix
            backend:
              service:
                name: lidar-api-service
                port:
                  number: 80
          - path: /api/datahub
            pathType: Prefix
            backend:
              service:
                name: datahub-api-service
                port:
                  number: 8000
          - path: /api/odoo
            pathType: Prefix
            backend:
              service:
                name: odoo-backend-service
                port:
                  number: 80
          - path: /api/gis
            pathType: Prefix
            backend:
              service:
                name: api-gateway-service
                port:
                  number: 5000
          - path: /api/v1/simulation
            pathType: Prefix
            backend:
              service:
                name: simulation-service
                port:
                  number: 5000
          - path: /api/risks
            pathType: Prefix
            backend:
              service:
                name: risk-api-service
                port:
                  number: 5000

    - host: nekazari.your-domain.com
      http:
        paths:
          - path: /api/lidar
            pathType: Prefix
            backend:
              service:
                name: lidar-api-service
                port:
                  number: 80
          - path: /ngsi-ld
            pathType: Prefix
            backend:
              service:
                name: api-gateway-service
                port:
                  number: 5000
          - path: /api/vegetation
            pathType: Prefix
            backend:
              service:
                name: vegetation-prime-api-service
                port:
                  number: 8000
          - path: /modules
            pathType: Prefix
            backend:
              service:
                name: frontend-static-service
                port:
                  number: 80
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-static-service
                port:
                  number: 80
